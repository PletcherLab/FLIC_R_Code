---
title: "FLIC: Data Analysis Part 3: Analysis of Choice Experiments"
author: "Scott Pletcher and the Pletcher Lab"
date: "9/2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

This document introduces functions designed to visual and output preference information when individual flies are placed in chambers containing two food choices. As with all FLIC R code, this is a work in progress, and these are the functions that our lab uses most often when analyzing these types of experiments. 

```{r}
rm(list=ls())
library(ggplot2)
library(stats)
library(gridExtra)
library(reshape2)
attach("FLICFunctions",pos=2)
```

As noted in the *Grouped Analysis* document, it is important to recognize three terms in this document and in the relevant data output, all of which refer in some way to the individual food wells or the overall feeding environment.  First,*Well Number* refers to the physical position of the food well on the DFM.  For any specific well, this number does not change and is independent of the type of experiment or lid. At present, there is a single model of DFM and the wells are numbered 1-12 from left to right and top to bottom. Second, the term *Chamber* refers to the physical space that a fly (or small number of flies) experience.  When obtained from our laboratory or from Sable Systems, the FLIC system includes lids that define 12 chambers (one food well in each chamber) or six chambers (choice chambers with two food wells in each chamber, one on the left and one on the right). Third, choice experiments (but not single-well experiments) identify *WellA* and *WellB*, where a preference index of PI = 1 indicates feeding 100% from *WellA*, and PI = -1 indicates 100% feeding on *WellB*. These wells are defined based on the *PI.Multiplier* parameter in a parameters object for a particular DFM.  *WellA* will be the left well of a two-well chamber if *PI.Multiplier* = 1, and it will be the right well if *PI.Multiplier* = -1.

We will use the same choice data that was examined in some depth in the document that describes *Grouped Analysis*. As a reminder, the choice experiment followed good design principles and swapped the food wells (sucrose vs. denatonium) on different DFM. On DFMs 11, 13, 15, and 17, denatonium food was made available from the right well in each chamber with standard sucrose food on the left.  In DFMs 12, 14, and 16, the food was switched such that denatonium was present on the left side and sucrose on the right. We will choose to present the data in terms of preference FOR denatonium, because flies normally will avoid this bitter substance.  Thus, we will set PI.Multiplier to 1 when denatonium is present in the left well and -1 when it is present in the right well. As a result, 'WellA' will always refer to wells with denatonium ('WellB' will always refer to sucrose only), regardless of the physical position of the well in the specific DFM.

```{r}
p.choice.one<-ParametersClass.TwoWell()
p.choice.two<-ParametersClass.TwoWell()
p.choice.two<-SetParameter(p.choice.two,PI.Multiplier=-1.0)
monitors.choice<-c(11,12,13,14,15,16,17)
p.choice.list<-list(p.choice.two,p.choice.one,p.choice.two,p.choice.one,p.choice.two,p.choice.one,p.choice.two)
```

The plots and data output generated by the functions in this document essentially provide simple wrappers for the grouped analysis functions described in the accompanying documentation. The goal here is to allow quick and easy analysis of the preference index (PI), which is defined here as $PI=(WellA-WellB)/(WellA+WellB)$, were the values for wells A and B can be licks or events. When calculating PI, licks are **NOT** transformed. Please see the *Getting Started* document section *Feeding and Tasting Interactions* for a refresher on the difference between licks and events.

## Interrogating the Data

To view the change in PI over the course of the experiment, or a defined time period within, for each of the six chambers in a single DFM, use the cumulative PI functions *Feeding.CumulativePI.DFM()* and *Feeding.CumulativeEventPI.DFM()* for licks and events, respectively. These functions require a specific DFM as an argument, so we first need to read one in from the data file.

```{r}
dfm<-DFMClass(11,p.choice.two)
``` 

With the default options, these functions produce one cumulative PI plot for each chamber for the entire experiment. The cumulative PI is calculated using the summed licks or events from the beginning of the experiment (or the beginning of the range if that argument is provided) to the point in question. In these plots, individual points refer to times in which licks or events were recorded.  Time spans over which points are connected by lines experience no feeding interactions. The number of licks that were used to calculate the PI is encoded in the color of the points.  This helps distinguish PI values that result from a few sporatic interactions from those that result from many interactions and sustained feeding. 

```{r, fig.height=8, fig.cap="Figure 1"}
dfm.pi<-Feeding.CumulativePI.DFM(dfm)
```

In this example, chambers 5 and 6 experienced far fewer interactions than did chambers 2 and 4 and they maintained a preference for sucrose only food (no denatonium) throughout.  Chambers 2 and 4 (which in fact are the flies that experienced opto simulation) exhibit significantly more interactions and a strong preference for the denatonium food. Chamber 5 exhibited only a few interactions, beginning at least 250min into the experiment.

The Event PI looks similar, although it is important to note that this will not always be the case.

```{r, fig.height=8, fig.cap="Figure 2"}
dfm.eventpi<-Feeding.CumulativeEventPI.DFM(dfm)
```

These functions return a data frame with the PI information, which can be used for futher analysis.

```{r}
head(dfm.pi)
head(dfm.eventpi)
```


Column                  |   Definition
----------------------- | ---------------------------------------------------------------------------------------
Minutes                 | The elapsed time (in minutes) since the beginning of the experiment.
PI                      | The cumulative PI.
Chamber                 | The chamber (numbered from 1-6 from top to bottom) for which the data corresponds.
Licks/EventNum          | The total number of licks or events that were used to calculate the PI.


Contrary to the data in the DFM object, the data frame that is returned form these functions contains entries at times in which licks/events were recorded, which are listed as individual rows.


Both functions accept a *range* argument (in minutes) to focus the analysis as well as options to suppress the output of the plot (if you would just like to recover the data frame) or to place data from all chambers on a single plot. If a range is specified, the PI is set at 0 at the start of the range and the cumulative PI is calculated beginning at that point in the experiment.

```{r, fig.height=8}
dfm.pi.2<-Feeding.CumulativePI.DFM(dfm,range=c(200,300))
```

Note that for chambers 2 and 4, the cumulative PI from the start of the experiment is significantly positive at 200min (see Figure 1).  However, when the analysis is focussed to the interval from 200-300 minutes, the PIs for these two chambers are strongly negative (favoring sucrose).  This pattern indicates that the preference changes during the experiment (from favoring the denatonium food to the sucrose food) but that the later feeding on sucrose alone is not sufficiently frequent to modify the cumulative PI, which is dominated by lots of early feeding from the denatonium well.  This will become more apparent below when we bin the data and analyse the PI for individual bins.

To suppress the plot output set *ShowPlots=FALSE* and to group all chambers onto a single plot, set *SinglePlot=TRUE*

```{r}
dfm.pi<-Feeding.CumulativePI.DFM(dfm,ShowPlots=FALSE)
dfm.pi<-Feeding.CumulativePI.DFM(dfm,SinglePlot=TRUE)
```

When *SinglePlot=TRUE* the color encoding indicates individual chambers instead of the total number of licks/events.


## Treatment-Based Analysis
#### PI Summary

Several functions are available for plotting PI data with respect to treatments. These functions all require an experimental design argument as well as most other arguments that we have seen before. To display a dot plot and box plot of flies for each treatment for the entire experiment (i.e., when *range=c(0,0)*) and save the plot to a file use *Feeding.PIPlot.Trt()*. If *SaveToFile=TRUE* then no plots will be produced in the R window, and all existing graphics windows will be closed. Plots are saved as either a *.pdf* or *.png* file.

Read the experimental design data into R using the *read.csv()* function.

```{r}
expDesign<-read.csv("ExpDesign.csv")
head(expDesign)
```


```{r}
Feeding.PIPlot.Trt(monitors.choice,p.choice.list,expDesign)
```

The number of licks is encoded in the color of the points, with counts indicated in the legend.

If *SaveToFile=TRUE* a *.pdf* file of the plot will be saved. 

```{r}
Feeding.PIPlot.Trt(monitors.choice,p.choice.list,expDesign,SaveToFile=TRUE)
```

This function can also be used to split the data and examine successive PI values through the experiment. For example, to split the first 200 minutes into four divisions, each consisting of an additional 50 min, you must override the default divisions parameter. Please note that this option does not split the range into non-overlapping regions (that would be more appropriate for binned PI plots, which are described below). Instead, each division includes the beginning of the range and a different end point.

```{r,  fig.height=7.5,  fig.width=7.5}
Feeding.PIPlot.Trt(monitors.choice,p.choice.list,expDesign,divisions=4,range=c(0,200))
```

A corresponding function for events is provided as well.  It has the same options and argument list.

```{r}
Feeding.EventPIPlot.Trt(monitors.choice,p.choice.list,expDesign)
```

```{r,  fig.height=7.5,  fig.width=7.5}
Feeding.EventPIPlot.Trt(monitors.choice,p.choice.list,expDesign,divisions=4,range=c(0,200))
```

#### Time-dependent PI

As mentioned above, there was an indication in our DFM analysis that, at least for some flies and treatments, the PI changed over time. The cumulative PI can easily mask such dynamics. To investigate time-dependent changes in the PI, one can divide the experiment into non-overlapping bins and calculate PI values at the end of each bin, using licks and events only from that bin. In this way, prior behaviors do not influence the current measure. 

The functions for obtaining and viewing the binned PI values are *BinnedFeeding.PIPlots.Trt()* and *BinnedFeeding.EventPIPlots.Trt()*. Their argument lists are presented at the end of this document, but in brief, they accept the same arguments as *Feeding.EventPIPlot.Trt()* with the exception that the *divisions* argument is replaces by *binsize.min*, which is required (and set to a default of 30min).

```{r,  fig.width=7.5}
BinnedFeeding.PIPlot.Trt(monitors.choice,p.choice.list,binsize.min=20,expDesign)
```

In this experiment, activated flies received optostimulation when feeding from Well A, but not from Well B for the first 180 minutes of the experiment.  For the second 180 minutes, no stimulation was provided. The binned PI data suggest that optostimulation specifically promotes preference for WellA (the well containing denatonium and indicated by a positive PI), which declines in the second part of the experiment when optosimulation is no longer provided. Statistical analysis of the number of licks for each well, including one-way ANOVAs applied to each interval, is detailed in the *Plotting Treatment Effects* of the "Grouped Analysis* document.

The same plot can be generated for events.

```{r,  fig.width=7.5}
BinnedFeeding.EventPIPlot.Trt(monitors.choice,p.choice.list,binsize.min=20,expDesign)
```

Finally,  to plot the cumulative PI values for each fly and overlay all of these with a smoothed value for each treatment, use *Feeding.CumulativePIPlots.Trt()* and *Feeding.CumulativeEventPIPlots.Trt()*.  These will be documented further in the next version of this documentation.

```{r,  fig.width=7.5}
cum.pi<-Feeding.CumulativePIPlots.Trt(monitors.choice,p.choice.list,expDesign)
```

```{r,  fig.width=7.5}
cum.eventpi<-Feeding.CumulativeEventPIPlots.Trt(monitors.choice,p.choice.list,expDesign)
```

The event PI can be displayed as a function of event number, rather than chronological time, if one would like to investigate the PI after each fly, say, executed up to 50 feeding events, regardless of when those events occured.

```{r,  fig.width=7.5}
cum.eventpi.bout<-Feeding.CumulativeEventPIPlots.Trt(monitors.choice,p.choice.list,expDesign,events.limit=50,by.bout=TRUE)
```

The *by.bout=TRUE* argument should be provided to ensure the x-axis is represented by bout number rather than elapsed minutes.  This can be a tricky way to interpret the results because not all flies will exhibit a the total number of boutrs (in this case 50) and will be included in only a portion of the calculations. Nevertheless, this is useful when the behavior is dependent on the number of times a fly feeds more than it is on the time of the experiment.

Each of these functions returns a large data frame containing all of the individual PI values, so it is recommended that is always be assigned to avoid a lengthy console output.

## Function Definition Reference
Listed below are the functions used in this document along with their argument list showing optional parameters and their default values.  You should know what each of these functions does and what each argument represents. It is important that these functions, and the larger set of R Code for the FLIC, are not treated as a black box. In our experience the FLIC system provides remarkable insights, but the data sets are large and complex and must be managed carefully to ensure that mistakes are avoided.


```{r, eval=FALSE}
Feeding.PIPlot.Trt<-function(monitors,parameters,expDesign,range=c(0,0),divisions=1,SaveToFile=FALSE)
Feeding.EventPIPlot.Trt<-function(monitors,parameters,expDesign,range=c(0,0),divisions=1,SaveToFile=FALSE)

BinnedFeeding.PIPlot.Trt<-function(monitors,parameters,binsize.min=30,expDesign=NA,range=c(0,0),SaveToFile=FALSE)
BinnedFeeding.EventPIPlot.Trt<-function(monitors,parameters,binsize.min=30,expDesign=NA,range=c(0,0),SaveToFile=FALSE)

Feeding.CumulativePI.DFM<-function(dfm, range=c(0,0), ShowPlots=TRUE, SinglePlot=FALSE)
Feeding.CumulativeEventPI.DFM<-function(dfm, events.limit=NA, range=c(0,0), ShowPlots=TRUE, SinglePlot=FALSE)

Feeding.CumulativePIPlots.Trt<-function(monitors,parameters,expDesign,range=c(0,0),SaveToFile=FALSE)
Feeding.CumulativeEventPIPlots.Trt<-function(monitors,parameters,expDesign,events.limit=NA,by.bout=FALSE,SaveToFile=FALSE)  
```

  
