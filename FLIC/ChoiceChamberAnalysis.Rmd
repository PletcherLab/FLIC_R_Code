---
title: "FLIC: Data Analysis Part 3: Analysis of Choice Experiments"
author: "Scott Pletcher and the Pletcher Lab"
date: "4/24/2020 (Version 4.x)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Overview

This document introduces functions designed to visual and output preference information when individual flies are placed in chambers containing two food choices. As with all FLIC R code, this is a work in progress, and these are the functions that our lab uses most often when analyzing these types of experiments. 

```{r}
rm(list=ls())
library(ggplot2)
library(stats)
library(gridExtra)
library(reshape2)
attach("FLICFunctions",pos=2)
```

As noted in the *Grouped Analysis* discussion, it is important to recognize three terms in this document and in the relevant data output, all of which refer in some way to the individual food wells or the overall feeding environment.  First,*Well Number* refers to the physical position of the food well on the DFM.  For any specific well, this number does not change, and it is independent of the type of experiment or lid. At present, all DFM versions have the wells numbered 1-12 from left to right and top to bottom. Second, the term *Chamber* refers to the physical space that a fly (or small number of flies) experience.  When obtained from our laboratory or from Sable Systems, the FLIC system includes lids that define 12 chambers (one food well in each chamber) or six chambers (choice chambers with two food wells in each chamber, one on the left and one on the right). Third, choice experiments (but not single-well experiments) identify *WellA* and *WellB*, where a preference index of PI = 1 indicates feeding 100% from *WellA*, and PI = -1 indicates 100% feeding on *WellB*. These wells are defined based on the *PI.Multiplier* parameter in a parameters object for a particular DFM.  *WellA* will be the left well of a two-well chamber if *PI.Multiplier* = 1, and it will be the right well if *PI.Multiplier* = -1. This naming scheme allows the experimenter to alter sides of a well for a particular treatment but ensure that the different wells are combined and represented as the same treatment.

We will use the same choice data that was examined in some depth in the document that describes *Grouped Analysis*. As a reminder, the choice experiment followed good design principles and swapped the food wells (sucrose vs. denatonium) on different DFM. On DFMs 11, 13, 15, and 17, denatonium water (bitter) was made available from the right well in each chamber with standard sucrose food (sweet) on the left.  In DFMs 12, 14, and 16, the food was switched such that denatonium was present on the left side and sucrose on the right. We will choose to present the data in terms of preference FOR denatonium, because flies normally will avoid this bitter substance.  Thus, we will set PI.Multiplier to 1 when denatonium is present in the left well and -1 when it is present in the right well. As a result, 'WellA' will always refer to wells with denatonium ('WellB' will always refer to sucrose), regardless of the physical position of the well in the specific DFM.

```{r}
p.single<-ParametersClass.SingleWell()
monitors.single<-c(1,2,3,4)

p.choice.one<-ParametersClass.TwoWell()
p.choice.two<-ParametersClass.TwoWell()
p.choice.two<-SetParameter(p.choice.two,PI.Multiplier=-1.0)
monitors.choice<-c(11,12,13,14,15,16,17)
p.choice.list<-list(p.choice.two,p.choice.one,p.choice.two,p.choice.one,p.choice.two,p.choice.one,p.choice.two)
```

The plots and data output generated by the functions in this document essentially provide simple wrappers for the grouped analysis functions described in the accompanying documentation. The goal here is to allow quick and easy analysis of the preference index (PI), which is defined here as $PI=(WellA-WellB)/(WellA+WellB)$, where the values for Wells A and B can be licks or events. When calculating PI, licks are **NOT** transformed. Please see the *Getting Started* document section *Feeding and Tasting Interactions* for a refresher on the difference between licks and events.

## Interrogating the Data

To view the change in PI over the course of the experiment, or a defined time period within, for each of the six chambers in a single DFM, use the cumulative PI functions *CumulativePI.DFM()* and *CumulativeEventPI.DFM()* for licks and events, respectively. These functions require a specific DFM as an argument, so we first need to read one in from the data file.

```{r}
dfm<-DFMClass(11,p.choice.two)
``` 

With the default options, these functions produce one cumulative PI plot for each chamber for the entire experiment. The cumulative PI is calculated using the summed licks or events from the beginning of the experiment (or the beginning of the range if that argument is provided) to the point in question. In these plots, individual points refer to times in which licks or events were recorded.  Time spans over which points are connected by lines experience no feeding interactions. The number of licks that were used to calculate the PI is encoded in the color of the points.  This helps distinguish PI values that result from a few sporatic interactions from those that result from many interactions and sustained feeding. 

```{r, fig.height=8, fig.cap="Figure 1"}
dfm.pi<-CumulativePI.DFM(dfm)
```

In this example, chambers 5 and 6 experienced far fewer interactions than did chambers 2 and 4 and they maintained a preference for sucrose only food (no denatonium) throughout.  Notice that the number of licks contributing to each PI calculation point is color coded according to the legend on the right. Chambers 2 and 4 (which in fact are the flies that experienced opto simulation) exhibit significantly more interactions and a strong preference for the denatonium food. Chamber 5 exhibited only a few interactions, beginning at least 250min into the experiment.

The Event PI looks similar, although it is important to note that this will not always be the case.

```{r, fig.height=8, fig.cap="Figure 2"}
dfm.eventpi<-CumulativeEventPI.DFM(dfm)
```

These functions return a data frame with the PI information, which can be used for futher analysis.

```{r}
head(dfm.pi)
head(dfm.eventpi)
```


Column                  |   Definition
----------------------- | ---------------------------------------------------------------------------------------
Minutes                 | The elapsed time (in minutes) since the beginning of the experiment.
PI                      | The cumulative PI.
Chamber                 | The chamber (numbered from 1-6 from top to bottom) for which the data corresponds.
Licks/EventNum          | The total number of licks or events that were used to calculate the PI.


Contrary to the data in the DFM object, the data frame that is returned from these functions contains entries at times in which licks/events were recorded, which are listed as individual rows.


Both functions accept a *range* argument (in minutes) to focus the analysis as well as additional options to suppress the output of the plot (if you would just like to recover the data frame) or to place data from all chambers on a single plot. If a range is specified, the PI is set to 0 at the start of the range, thus ignoring prior interactions, and the cumulative PI is calculated beginning at that point in the experiment.

```{r, fig.height=8}
dfm.pi.2<-CumulativePI.DFM(dfm,range=c(200,300))
```

Note that for chambers 2 and 4, the cumulative PI from the start of the experiment is significantly positive at 200min (see previous plot).  However, when the analysis is focussed to the interval from 200-300 minutes, the PIs for these two chambers are strongly negative (favoring sucrose).  This pattern indicates that the preference changes during the experiment (from favoring the denatonium food to the sucrose food) but that the later feeding on sucrose alone is not sufficiently frequent to modify the cumulative PI, which is dominated by a lot of early feeding from the denatonium well.  This will become more apparent below when we bin the data and analyse the PI for individual bins.

To suppress the plot output set *ShowPlots=FALSE* and to group all chambers onto a single plot, set *SinglePlot=TRUE*

```{r}
dfm.pi<-CumulativePI.DFM(dfm,ShowPlots=FALSE)
dfm.pi<-CumulativePI.DFM(dfm,SinglePlot=TRUE)
```

When *SinglePlot=TRUE* the color encoding indicates individual chambers instead of the total number of licks/events.


## Treatment-Based Analysis
#### PI Summary

Several of the plotting fuctions that were discussed in the *Grouped Analysis* documentation have a *Type* option for plotting the standard PI, which is derived from the lick data, or the EventPI. For example, the *DataPlot()* function can produce either.  First, however, we need to input the experimental design structure and complete the analysis for example choice experiment using the *Feeding.Summary.Monitors()* function.

```{r}
expDesign<-read.csv("ExpDesign.csv")
f.summary2<-Feeding.Summary.Monitors(monitors.choice,p.choice.list,,expDesign=expDesign,SaveToFile = TRUE)
```

We set *SaveToFile=TRUE* so that the data would also be saved to a *.csv* file.  Now the *DataPlot()* function is called specifying either *Type="PI"* or *Type="EventPI"*:

```{r}
DataPlot(f.summary2,Type="PI",SaveToFile=FALSE)
DataPlot(f.summary2,Type="EventPI",SaveToFile=FALSE)
```

Each chamber provides one point to the plot. The number of licks or events, respectively, that contribute to each measure is color coded and indicated in the legend on the right.  Note: Chambers that have zero licks or zero events (thus PI/EventPI=0) are removed. These are considered as not having participated in the experiment. ANOVA results for both WellA and WellB are output to the console. If *SaveToFile=TRUE* a *.pdf* file of the plot will be saved.   

```{r}
DataPlot(f.summary2,Type="PI",SaveToFile=TRUE)
```


As described in the *GroupedDataAnalysis.html* documentation, slightly more complicated version of these output plots is provided by the function *DivisionPlots()*, which divides the experiment (or the defined range) into a set number of divisions of equal durations and plots the PI or EventPI from the start of the range to the end of each division interval. For example, to split the first 200 minutes into four divisions, each consisting of an additional 50 min, you must override the default divisions parameter. Please note that this option does not split the range into non-overlapping regions (that would be more appropriate for binned PI plots, which are described below). Instead, each division includes the beginning of the range and a different end point. 

A box plot for each division is created, and a summary one-way ANOVA for each is output to the console. Because of the additional computation involved, the results from *Feeding.Summary.Monitors()* is not provided.  This function must be called several times within the *DivisionPlots()* function.  Therefore, a complete set of parameter arguments is required.

```{r, fig.height=7.5}
DivisionPlots(monitors.choice,p.choice.list,expDesign,range=c(0,200),divisions=4,Type="PI")
```

For Event PI:

```{r, fig.height=7.5}
DivisionPlots(monitors.choice,p.choice.list,expDesign,range=c(0,200),divisions=4,Type="EventPI")
```

#### Time-dependent PI

As mentioned above, there was an indication in our DFM analysis that, at least for some flies and treatments, the PI changed over time. The cumulative PI can easily mask such dynamics, even when divided. To investigate time-dependent changes in the PI, one can "bin the data" in the experiment into non-overlapping bins and calculate PI values at the end of each bin, using licks and events only from that bin. In this way, prior behaviors do not influence the measure in each time slice. 

As you might have predicted from the *Grouped Analysis* documentation, the procedure for doing this involves first calculating the binned summary data and then viewing the results using the *BinnedDataPlot()* function. We will examine 30min bins:

```{r}
f.binsummary2<-BinnedFeeding.Summary.Monitors(monitors.choice,p.choice.list,binsize.min=30,expDesign=expDesign,SaveToFile = TRUE)
BinnedDataPlot(f.binsummary2,Type="PI",SaveToFile=TRUE)
```

In this experiment, activated flies received closed-loop optostimulation when feeding from Well A, but not from Well B for the first 180 minutes of the experiment.  For the second 180 minutes, no stimulation was provided. The binned PI data suggest that optostimulation specifically promotes a higher preference for WellA (the well containing denatonium and indicated by a positive PI), which declines in the second part of the experiment when optosimulation is no longer provided. Statistical analysis of the number of licks for each well, including one-way ANOVAs applied to each interval, is detailed in the *Plotting Treatment Effects* of the "Grouped Analysis* document. The number of licks used to calculate each point is color coded, although this value is represented as *Transformed Licks* because that is the default behavior for the *BinnedFeeding.Summary.Monitors()* function. Although expressed here as transformed, the PI is calculated using untransformed data.

The same plot can be generated for Event PI, although we chose not to save this result to a .pdf file.

```{r,  fig.width=7.5}
BinnedDataPlot(f.binsummary2,Type="EventPI",SaveToFile=FALSE)
```

Finally, to plot the cumulative PI values for each chamber and overlay all of these with a smoothed value for each treatment, use *CumulativePIPlots()* and *CumulativeEventPIPlots()*.  These are generally very ugly, but we find that they are somewhat useful to get a global picture of behaviors in individual chambers. 

```{r,  fig.width=7.5}
CumulativePIPlots(monitors.choice,p.choice.list,expDesign)
```

```{r,  fig.width=7.5}
CumulativeEventPIPlots(monitors.choice,p.choice.list,expDesign)
```

The event PI can be displayed as a function of event number, rather than chronological time, if one would like to investigate the PI after each fly, say, executed up to 50 feeding events, regardless of when those events occured.

```{r,  fig.width=7.5}
CumulativeEventPIPlots(monitors.choice,p.choice.list,expDesign,events.limit=50,by.bout=TRUE)
```

The *by.bout=TRUE* argument is provided to indicate that the x-axis is represented by bout number rather than elapsed minutes.  This can be a tricky way to interpret the results because not all chambers will exhibit a similar number of bouts (in this case up to 50) and will be included in only a portion of the calculations. Nevertheless, this is useful when the behavior is dependent on the number of times a fly feeds more than it is on the time of exposure to food.

## Function Definition Reference
Listed below are the functions used in this document along with their argument list showing optional parameters and their default values.  You should know what each of these functions does and what each argument represents. It is important that these functions, and the larger set of R Code for the FLIC, are not treated as a black box. In our experience the FLIC system provides remarkable insights, but the data sets are large and complex and must be managed carefully to ensure that mistakes are avoided.


```{r, eval=FALSE}
CumulativePI.DFM<-function(dfm, range=c(0,0), ShowPlots=TRUE, SinglePlot=FALSE)

CumulativePIPlots<-function(monitors,parameters,expDesign,range=c(0,0),SaveToFile=FALSE)
  
CumulativeEventPI.DFM<-function(dfm, events.limit=NA, range=c(0,0), ShowPlots=TRUE, SinglePlot=FALSE)

CumulativeEventPIPlots<-function(monitors,parameters,expDesign,events.limit=NA,by.bout=FALSE,SaveToFile=FALSE)
  
Feeding.Summary.Monitors<-function(monitors,parameters,expDesign=NA,range=c(0,0),SaveToFile=TRUE,TransformLicks=TRUE,filename="FeedingSummary")

BinnedFeeding.Summary.Monitors<-function(monitors,parameters,binsize.min=30,expDesign=NA,range=c(0,0),SaveToFile=TRUE,TransformLicks=TRUE,filename="BinnedSummary")
  
BinnedDataPlot<-function(binnedDataResult,Type="Licks",SaveToFile=FALSE)

DataPlot<-function(summaryResults,Type="Licks",SaveToFile=FALSE)

DivisionPlots<-function(monitors,parameters,expDesign,range=c(0,0),divisions=1,Type="Licks",SaveToFile=FALSE,TransformLicks=TRUE)
```

  
